<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="é”µé”µé”µé”µçš„å°ä¸–ç•Œ">
    <meta name="theme-color" content="#FDF8F6">
    <title>é”µé”µé”µé”µçš„å°ä¸–ç•Œ</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='90' fill='%23C4908F'/><text x='256' y='320' font-size='280' text-anchor='middle'>âœ¨</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='90' fill='%23C4908F'/><text x='256' y='320' font-size='280' text-anchor='middle'>âœ¨</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FDF8F6;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #F5EFED;
            --bg-warm: #FAF0ED;
            --text-primary: #4A3F3F;
            --text-secondary: #7A6B6B;
            --text-tertiary: #A89999;
            --accent: #C4908F;
            --accent-light: #F8EEED;
            --accent-soft: #E8C5C4;
            --accent-deep: #B07472;
            --success: #7DB59A;
            --success-light: #E8F4ED;
            --warning: #D4A574;
            --warning-light: #FDF4EB;
            --danger: #C97B7B;
            --danger-light: #FCEAEA;
            --gold: #C9A962;
            --border: #EDE5E3;
            --shadow-sm: 0 1px 3px rgba(74,63,63,0.04);
            --shadow-md: 0 4px 12px rgba(74,63,63,0.06);
            --shadow-lg: 0 8px 24px rgba(74,63,63,0.08);
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-full: 9999px;
            --font-serif: 'Noto Serif SC', serif;
            --font-sans: 'Noto Sans SC', -apple-system, sans-serif;
        }

        [data-theme="dark"] {
            --bg-primary: #1C1917;
            --bg-secondary: #292524;
            --bg-tertiary: #3D3835;
            --bg-warm: #2D2624;
            --text-primary: #F5F0EE;
            --text-secondary: #B8A9A6;
            --text-tertiary: #8A7B78;
            --accent: #D4A5A4;
            --accent-light: #3D2F2E;
            --accent-soft: #5C4544;
            --accent-deep: #E8B8B7;
            --success: #8FC9A8;
            --success-light: #2D3D34;
            --warning: #E0B88A;
            --warning-light: #3D352A;
            --danger: #D99B9B;
            --danger-light: #3D2A2A;
            --gold: #D9BC7A;
            --border: #3D3835;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-primary);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            padding-top: calc(14px + env(safe-area-inset-top));
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-deep) 100%);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .logo-text {
            font-family: var(--font-serif);
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .theme-toggle {
            width: 38px;
            height: 38px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 16px 20px;
            padding-bottom: 100px;
            opacity: 0;
            transform: translateY(8px);
            pointer-events: none;
            transition: all 0.25s ease;
        }

        .page.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        /* Priority Task Card - The Main Focus */
        .priority-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-warm) 100%);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }

        .priority-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-deep);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .priority-task-text {
            font-family: var(--font-serif);
            font-size: 18px;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .priority-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .priority-meta .urgent {
            color: var(--danger);
            font-weight: 500;
        }

        .priority-status {
            margin-top: 12px;
            padding: 10px 14px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Encouragement Message */
        .encouragement {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .encouragement-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .encouragement-text strong {
            color: var(--accent-deep);
        }

        /* Reminder Banner */
        .reminder-banner {
            background: linear-gradient(135deg, var(--warning-light) 0%, var(--accent-light) 100%);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            display: none;
        }

        .reminder-banner.active {
            display: block;
            animation: gentlePulse 3s ease-in-out infinite;
        }

        @keyframes gentlePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .reminder-text {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
        }

        .section-count {
            font-size: 12px;
            color: var(--text-tertiary);
            background: var(--bg-tertiary);
            padding: 2px 10px;
            border-radius: var(--radius-full);
        }

        /* Task List */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 24px;
        }

        .task-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .task-card.completed {
            opacity: 0.6;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .task-checkbox:hover {
            border-color: var(--accent);
        }

        .task-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .task-checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            word-break: break-word;
        }

        .task-card.completed .task-text {
            text-decoration: line-through;
            color: var(--text-tertiary);
        }

        .task-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .task-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .task-time.urgent {
            color: var(--danger);
            font-weight: 500;
        }

        .task-time.soon {
            color: var(--warning);
        }

        .task-rank {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            background: var(--accent-light);
            color: var(--accent-deep);
        }

        .task-delete {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .task-card:hover .task-delete {
            opacity: 1;
        }

        .task-delete:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.6;
        }

        .empty-text {
            font-size: 14px;
            line-height: 1.6;
        }

        /* Tabs for History */
        .task-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .task-tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        /* Chat Input Area */
        .chat-input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 8px 12px;
            transition: all 0.2s ease;
        }

        .chat-input-wrapper:focus-within {
            box-shadow: 0 0 0 2px var(--accent-soft);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            font-family: var(--font-sans);
            font-size: 15px;
            color: var(--text-primary);
            resize: none;
            max-height: 100px;
            min-height: 22px;
            line-height: 1.5;
            outline: none;
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 34px;
            height: 34px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Snippet Page */
        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 14px;
            margin-bottom: 12px;
        }

        .search-box svg {
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--text-primary);
            outline: none;
        }

        .snippet-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .category-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-full);
            font-family: var(--font-sans);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .category-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .snippet-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .snippet-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            border: 1px solid var(--border);
        }

        .snippet-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .snippet-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .snippet-actions {
            display: flex;
            gap: 4px;
        }

        .snippet-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .snippet-btn.copy-btn:hover {
            background: var(--success-light);
            color: var(--success);
        }

        .snippet-btn.delete-btn:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        .snippet-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 60px;
            overflow: hidden;
        }

        .snippet-tags {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .snippet-tag {
            font-size: 11px;
            padding: 2px 8px;
            background: var(--accent-light);
            color: var(--accent-deep);
            border-radius: var(--radius-full);
        }

        /* Settings */
        .settings-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-icon {
            width: 34px;
            height: 34px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .settings-text h4 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-text p {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .toggle {
            width: 46px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle.active {
            background: var(--accent);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: var(--radius-full);
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .toggle.active::after {
            left: 23px;
        }

        .export-btn {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-sans);
            font-size: 13px;
            cursor: pointer;
        }

        /* Bottom Nav */
        .bottom-nav {
            display: flex;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 10px 8px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-family: var(--font-sans);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-item.active {
            color: var(--accent);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(74,63,63,0.4);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: var(--font-serif);
            font-size: 18px;
            font-weight: 500;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-primary);
            outline: none;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .priority-select {
            display: flex;
            gap: 8px;
        }

        .priority-option {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            cursor: pointer;
            text-align: center;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .priority-option.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            color: var(--accent-deep);
        }

        .form-submit {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Progress Dialog */
        .progress-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(74,63,63,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            padding: 20px;
        }

        .progress-dialog.active {
            opacity: 1;
            pointer-events: auto;
        }

        .progress-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 100%;
            max-width: 320px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.25s ease;
        }

        .progress-dialog.active .progress-card {
            transform: scale(1);
        }

        .progress-emoji {
            font-size: 40px;
            margin-bottom: 16px;
        }

        .progress-question {
            font-family: var(--font-serif);
            font-size: 16px;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .progress-task-name {
            font-size: 14px;
            color: var(--accent-deep);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .progress-buttons {
            display: flex;
            gap: 10px;
        }

        .progress-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .progress-btn.no {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .progress-btn.yes {
            background: var(--accent);
            color: white;
        }

        /* Feedback Message */
        .feedback-message {
            background: var(--success-light);
            border: 1px solid var(--success);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
            display: none;
        }

        .feedback-message.active {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        .feedback-message.gentle {
            background: var(--warning-light);
            border-color: var(--warning);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Add Button */
        .add-btn {
            position: fixed;
            bottom: calc(85px + env(safe-area-inset-bottom));
            right: 20px;
            width: 52px;
            height: 52px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 22px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .add-btn.visible {
            display: flex;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: calc(20px + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%) translateY(-80px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 12px 20px;
            border-radius: var(--radius-full);
            font-size: 13px;
            z-index: 2000;
            transition: transform 0.3s ease;
        }

        .toast.active {
            transform: translateX(-50%) translateY(0);
        }

        /* Recognition Popup */
        .recognition-popup {
            position: fixed;
            bottom: 130px;
            left: 20px;
            right: 20px;
            max-width: 440px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            opacity: 0;
            pointer-events: none;
            transform: translateY(10px);
            transition: all 0.25s ease;
            z-index: 500;
        }

        .recognition-popup.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .recognition-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .recognition-text strong {
            color: var(--accent-deep);
        }

        .recognition-actions {
            display: flex;
            gap: 8px;
        }

        .recognition-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-sans);
            font-size: 13px;
            cursor: pointer;
        }

        .recognition-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .recognition-btn.primary {
            background: var(--accent);
            color: white;
        }

        /* Reminder Sync Modal */
        .reminder-intro {
            background: var(--bg-warm);
            padding: 12px 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .reminder-intro p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .reminder-schedule {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }

        .reminder-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border);
        }

        .reminder-item:last-child {
            border-bottom: none;
        }

        .reminder-date {
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-deep);
            min-width: 90px;
        }

        .reminder-times {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .reminder-text-preview {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-primary);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .reminder-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .reminder-skip {
            width: 100%;
            padding: 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--text-tertiary);
            cursor: pointer;
        }

        .reminder-tip {
            display: none;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding: 12px 14px;
            background: var(--success-light);
            border: 1px solid var(--success);
            border-radius: var(--radius-md);
            animation: gentlePulse 2s ease-in-out infinite;
        }

        .reminder-tip.active {
            display: flex;
        }

        .reminder-tip .tip-icon {
            font-size: 18px;
        }

        .reminder-tip span {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">âœ¨</div>
                <span class="logo-text">é”µé”µé”µé”µçš„å°ä¸–ç•Œ</span>
            </div>
            <button class="theme-toggle" id="themeToggle">â˜€ï¸</button>
        </header>

        <main class="main-content">
            <!-- Tasks Page -->
            <div class="page active" id="tasksPage">
                <!-- Priority Task -->
                <div class="priority-card" id="priorityCard" style="display: none;">
                    <div class="priority-label">ğŸ¯ ç°åœ¨æœ€è¯¥åšçš„</div>
                    <div class="priority-task-text" id="priorityTaskText"></div>
                    <div class="priority-meta" id="priorityMeta"></div>
                    <div class="priority-status" id="priorityStatus"></div>
                </div>

                <!-- Feedback Message -->
                <div class="feedback-message" id="feedbackMessage">
                    <p class="feedback-text" id="feedbackText"></p>
                </div>

                <!-- Reminder Banner -->
                <div class="reminder-banner" id="reminderBanner">
                    <p class="reminder-text" id="reminderText"></p>
                </div>

                <!-- Encouragement (when no priority task) -->
                <div class="encouragement" id="encouragement">
                    <p class="encouragement-text" id="encouragementText"></p>
                </div>

                <!-- Task Tabs -->
                <div class="task-tabs">
                    <button class="task-tab active" data-tab="pending">å¾…å®Œæˆ</button>
                    <button class="task-tab" data-tab="completed">å·²å®Œæˆ</button>
                </div>

                <!-- Pending Tasks -->
                <div id="pendingSection">
                    <div class="section-header">
                        <span class="section-title">ä»»åŠ¡åˆ—è¡¨</span>
                        <span class="section-count" id="pendingCount">0</span>
                    </div>
                    <div class="task-list" id="pendingTaskList"></div>
                    <div class="empty-state" id="emptyPending" style="display: none;">
                        <div class="empty-icon">ğŸŒ¸</div>
                        <p class="empty-text">æ²¡æœ‰å¾…åŠä»»åŠ¡~<br>åœ¨ä¸‹æ–¹è¾“å…¥æ¡†éšæ‰‹è®°å½•å§</p>
                    </div>
                </div>

                <!-- Completed Tasks -->
                <div id="completedSection" style="display: none;">
                    <div class="section-header">
                        <span class="section-title">å·²å®Œæˆ</span>
                        <span class="section-count" id="completedCount">0</span>
                    </div>
                    <div class="task-list" id="completedTaskList"></div>
                    <div class="empty-state" id="emptyCompleted" style="display: none;">
                        <div class="empty-icon">ğŸ“</div>
                        <p class="empty-text">è¿˜æ²¡æœ‰å®Œæˆçš„ä»»åŠ¡~<br>å®Œæˆåä¼šåœ¨è¿™é‡Œä¿ç•™è®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- Snippets Page -->
            <div class="page" id="snippetsPage">
                <div class="search-box">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search-input" id="snippetSearch" placeholder="æœç´¢ç‰‡æ®µ...">
                </div>

                <div class="snippet-categories" id="categories">
                    <button class="category-btn active" data-category="all">å…¨éƒ¨</button>
                    <button class="category-btn" data-category="academic">ğŸ“š å­¦æœ¯</button>
                    <button class="category-btn" data-category="ai">ğŸ¤– AIæŒ‡ä»¤</button>
                    <button class="category-btn" data-category="account">ğŸ” è´¦å·</button>
                    <button class="category-btn" data-category="template">ğŸ“‹ æ¨¡æ¿</button>
                    <button class="category-btn" data-category="other">ğŸ’¬ å…¶ä»–</button>
                </div>

                <div class="snippet-list" id="snippetList"></div>
                <div class="empty-state" id="emptySnippets" style="display: none;">
                    <div class="empty-icon">ğŸ“Œ</div>
                    <p class="empty-text">è¿˜æ²¡æœ‰ç‰‡æ®µ~<br>ç‚¹å‡»å³ä¸‹è§’æ·»åŠ å¸¸ç”¨å†…å®¹</p>
                </div>
            </div>

            <!-- Settings Page -->
            <div class="page" id="settingsPage">
                <div class="section-title" style="margin-bottom: 12px;">å¤–è§‚</div>
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="settings-label">
                            <div class="settings-icon">ğŸŒ™</div>
                            <div class="settings-text">
                                <h4>æ·±è‰²æ¨¡å¼</h4>
                                <p>å¤œé—´ä½¿ç”¨æ›´æŠ¤çœ¼</p>
                            </div>
                        </div>
                        <div class="toggle" id="darkModeToggle"></div>
                    </div>
                </div>

                <div class="section-title" style="margin-bottom: 12px;">æ•°æ®</div>
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="settings-label">
                            <div class="settings-icon">ğŸ“¤</div>
                            <div class="settings-text">
                                <h4>å¯¼å‡ºå¤‡ä»½</h4>
                                <p>ä¿å­˜ä»»åŠ¡å’Œç‰‡æ®µ</p>
                            </div>
                        </div>
                        <button class="export-btn" id="exportBtn">å¯¼å‡º</button>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">
                            <div class="settings-icon">ğŸ“¥</div>
                            <div class="settings-text">
                                <h4>å¯¼å…¥æ•°æ®</h4>
                                <p>ä»å¤‡ä»½æ¢å¤</p>
                            </div>
                        </div>
                        <button class="export-btn" id="importBtn">å¯¼å…¥</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>

                <div class="section-title" style="margin-bottom: 12px;">å…³äº</div>
                <div class="settings-section">
                    <div class="settings-item">
                        <div class="settings-label">
                            <div class="settings-icon">ğŸ’¡</div>
                            <div class="settings-text">
                                <h4>ä½¿ç”¨æç¤º</h4>
                                <p>é…åˆiPhoneæé†’äº‹é¡¹è·å¾—æ¨é€é€šçŸ¥</p>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label">
                            <div class="settings-icon">ğŸŒ¸</div>
                            <div class="settings-text">
                                <h4>ç‰ˆæœ¬</h4>
                                <p>é”µé”µé”µé”µçš„å°ä¸–ç•Œ v2.0</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Chat Input -->
        <div class="chat-input-area" id="chatInputArea">
            <div class="chat-input-wrapper">
                <textarea class="chat-input" id="chatInput" placeholder="è®°å½•ä»»åŠ¡ï¼Œæˆ–å‘Šè¯‰æˆ‘ï¼šå¼€å§‹äº†/æ²¡åš/ç„¦è™‘..." rows="1"></textarea>
                <button class="send-btn" id="sendBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Bottom Nav -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="tasks">
                <span class="nav-icon">âœ“</span>
                <span>ä»»åŠ¡</span>
            </button>
            <button class="nav-item" data-page="snippets">
                <span class="nav-icon">ğŸ“Œ</span>
                <span>ç‰‡æ®µ</span>
            </button>
            <button class="nav-item" data-page="settings">
                <span class="nav-icon">âš™ï¸</span>
                <span>è®¾ç½®</span>
            </button>
        </nav>

        <!-- Add Button -->
        <button class="add-btn" id="addBtn">+</button>

        <!-- Recognition Popup -->
        <div class="recognition-popup" id="recognitionPopup">
            <p class="recognition-text" id="recognitionText"></p>
            <div class="recognition-actions">
                <button class="recognition-btn secondary" id="recognitionCancel">åªæ˜¯è®°å½•</button>
                <button class="recognition-btn primary" id="recognitionConfirm">åˆ›å»ºä»»åŠ¡</button>
            </div>
        </div>

        <!-- Progress Dialog -->
        <div class="progress-dialog" id="progressDialog">
            <div class="progress-card">
                <div class="progress-emoji">ğŸŒ·</div>
                <p class="progress-question" id="progressQuestion"></p>
                <p class="progress-task-name" id="progressTaskName"></p>
                <div class="progress-buttons">
                    <button class="progress-btn no" id="progressNo">è¿˜æ²¡å‘¢</button>
                    <button class="progress-btn yes" id="progressYes">åœ¨åšäº†ï¼</button>
                </div>
            </div>
        </div>

        <!-- Task Modal -->
        <div class="modal-overlay" id="taskModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">å®Œå–„ä»»åŠ¡</h3>
                    <button class="modal-close" id="closeTaskModal">âœ•</button>
                </div>
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡å†…å®¹</label>
                    <input type="text" class="form-input" id="taskTitleInput" placeholder="åšä»€ä¹ˆ...">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" class="form-input" id="taskDateInput">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ—¶é—´</label>
                        <input type="time" class="form-input" id="taskTimeInput">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼˜å…ˆçº§</label>
                    <div class="priority-select">
                        <div class="priority-option" data-priority="low">ä½</div>
                        <div class="priority-option selected" data-priority="medium">ä¸­</div>
                        <div class="priority-option" data-priority="high">é«˜</div>
                    </div>
                </div>
                <button class="form-submit" id="saveTaskBtn">ä¿å­˜ä»»åŠ¡</button>
            </div>
        </div>

        <!-- Snippet Modal -->
        <div class="modal-overlay" id="snippetModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title" id="snippetModalTitle">æ·»åŠ ç‰‡æ®µ</h3>
                    <button class="modal-close" id="closeSnippetModal">âœ•</button>
                </div>
                <div class="form-group">
                    <label class="form-label">æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="snippetTitleInput" placeholder="ç»™ç‰‡æ®µèµ·ä¸ªåå­—...">
                </div>
                <div class="form-group">
                    <label class="form-label">å†…å®¹</label>
                    <textarea class="form-input form-textarea" id="snippetContentInput" placeholder="ç‰‡æ®µå†…å®¹..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">åˆ†ç±»</label>
                    <select class="form-input" id="snippetCategorySelect">
                        <option value="academic">ğŸ“š å­¦æœ¯ç›¸å…³</option>
                        <option value="ai">ğŸ¤– AIæŒ‡ä»¤</option>
                        <option value="account">ğŸ” è´¦å·ä¿¡æ¯</option>
                        <option value="template">ğŸ“‹ æ¨¡æ¿</option>
                        <option value="other">ğŸ’¬ å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æ ‡ç­¾ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</label>
                    <input type="text" class="form-input" id="snippetTagsInput" placeholder="ä¾‹å¦‚ï¼šè®ºæ–‡ é‡è¦">
                </div>
                <button class="form-submit" id="saveSnippetBtn">ä¿å­˜</button>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast"></div>

        <!-- Reminder Sync Modal -->
        <div class="modal-overlay" id="reminderModal">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">ğŸ“± åŒæ­¥åˆ°æé†’äº‹é¡¹</h3>
                    <button class="modal-close" id="closeReminderModal">âœ•</button>
                </div>
                <div class="reminder-intro">
                    <p>æˆ‘å¸®ä½ ç®—å¥½äº†æé†’æ—¶é—´ï¼Œå¤åˆ¶åå»iPhoneã€Œæé†’äº‹é¡¹ã€ç²˜è´´å°±è¡Œ~</p>
                </div>
                <div class="reminder-schedule" id="reminderSchedule"></div>
                <div class="reminder-actions">
                    <button class="form-submit" id="copyAllReminders">ğŸ“‹ ä¸€é”®å¤åˆ¶å…¨éƒ¨</button>
                    <button class="reminder-skip" id="skipReminder">å…ˆä¸è®¾ç½®</button>
                </div>
                <div class="reminder-tip" id="reminderTip">
                    <span class="tip-icon">ğŸ‘†</span>
                    <span>å¤åˆ¶åï¼Œ<strong>ç°åœ¨å°±å»</strong>ã€Œæé†’äº‹é¡¹ã€App æ–°å»ºæé†’å¹¶ç²˜è´´å“¦ï¼</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== State ====================
        let tasks = JSON.parse(localStorage.getItem('qqqq_tasks')) || [];
        let snippets = JSON.parse(localStorage.getItem('qqqq_snippets')) || [];
        let appState = JSON.parse(localStorage.getItem('qqqq_state')) || {
            lastVisit: null,
            lastProgressCheck: null,
            progressResponses: {}
        };
        let currentCategory = 'all';
        let currentTab = 'pending';
        let editingSnippetId = null;
        let pendingTaskText = '';

        // ==================== Smart Reply System ====================
        
        // æ—¶é—´æ„ŸçŸ¥
        function getTimeContext() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 9) return { period: 'earlyMorning', label: 'ä¸€å¤§æ—©' };
            if (hour >= 9 && hour < 12) return { period: 'morning', label: 'ä¸Šåˆ' };
            if (hour >= 12 && hour < 14) return { period: 'noon', label: 'ä¸­åˆ' };
            if (hour >= 14 && hour < 18) return { period: 'afternoon', label: 'ä¸‹åˆ' };
            if (hour >= 18 && hour < 22) return { period: 'evening', label: 'æ™šä¸Š' };
            return { period: 'lateNight', label: 'è¿™ä¹ˆæ™š' };
        }

        // æ„å›¾è¯†åˆ«å…³é”®è¯ - ç ”ç©¶ç”Ÿæ—¥å¸¸è¡¨è¾¾
        const intentPatterns = {
            started: ['å¼€å§‹åšäº†', 'å¼€å§‹äº†', 'åœ¨åšäº†', 'åšèµ·æ¥äº†', 'åŠ¨æ‰‹äº†', 'å¼€å·¥äº†', 'å¼€å¹²', 'å¹²èµ·æ¥', 'å¼€å§‹å¹²', 'è¦å¼€å§‹', 'å‡†å¤‡å¼€å§‹', 'é©¬ä¸Šå¼€å§‹', 'è¿™å°±å»', 'å»åšäº†', 'å†²äº†', 'å¹²æ´»å»', 'åŠ¨èµ·æ¥äº†', 'ç€æ‰‹', 'å…¥æ‰‹äº†'],
            progress: [
                // é€šç”¨è¿›åº¦
                'åšäº†ä¸€ç‚¹', 'åšäº†ä¸€äº›', 'æœ‰è¿›å±•', 'æ¨è¿›äº†', 'å†™äº†ä¸€ç‚¹', 'åšåˆ°', 'å®Œæˆäº†ä¸€éƒ¨åˆ†', 'å¼„äº†ä¸€äº›', 'æäº†ä¸€äº›',
                // ç ”ç©¶ç›¸å…³
                'æ‰¾åˆ°äº†', 'æ‰¾å¥½äº†', 'æ”¶é›†åˆ°', 'æ”¶é›†å¥½', 'æ•´ç†å¥½', 'æ•´ç†å®Œ', 'ä¸‹è½½å¥½', 'ä¸‹è½½å®Œ',
                'åœ¨è·‘', 'è·‘äº†', 'è·‘èµ·æ¥', 'åœ¨è¿è¡Œ', 'è¿è¡Œäº†', 'åœ¨ç®—', 'ç®—äº†', 
                'åœ¨å†™', 'å†™åˆ°', 'å†™äº†', 'æ”¹äº†', 'æ”¹åˆ°', 'ä¿®äº†',
                'åœ¨çœ‹', 'çœ‹äº†', 'çœ‹å®Œ', 'è¯»äº†', 'è¯»åˆ°', 'è¯»å®Œ',
                'åœ¨è°ƒ', 'è°ƒäº†', 'è°ƒå¥½', 'è°ƒå®Œ', 'åœ¨è¯•', 'è¯•äº†',
                'å‡†å¤‡è·‘', 'å‡†å¤‡å†™', 'å‡†å¤‡åš', 'å‡†å¤‡äº¤',
                'å¼„å¥½äº†', 'æå¥½äº†', 'å¤„ç†å¥½', 'å¤„ç†å®Œ',
                'å·®ä¸å¤š', 'å¿«å¥½äº†', 'å¿«å®Œäº†', 'å¿«å†™å®Œ', 'å¿«åšå®Œ',
                'è¿˜åœ¨', 'ç»§ç»­', 'æ¥ç€',
                // æ•°æ®/å®éªŒç›¸å…³
                'æ•°æ®', 'å®éªŒ', 'ä»£ç ', 'æ¨¡å‹', 'ç»“æœ', 'å›¾è¡¨', 'è®ºæ–‡'
            ],
            done: ['åšå®Œäº†', 'å®Œæˆäº†', 'æå®šäº†', 'äº¤äº†', 'ç»“æŸäº†', 'done', 'ç»ˆäºåšå®Œ', 'å¼„å®Œäº†', 'å†™å®Œäº†', 'å…¨éƒ¨å®Œæˆ', 'è·‘å®Œäº†', 'ç®—å®Œäº†', 'å‡ºç»“æœäº†', 'é€šè¿‡äº†', 'è¿‡äº†'],
            notDone: ['æ²¡åš', 'æ²¡å¼€å§‹', 'è¿˜æ²¡', 'ä¸€ç‚¹æ²¡åŠ¨', 'æ²¡åŠ¨', 'æ²¡å†™', 'å•¥ä¹Ÿæ²¡å¹²', 'ä»€ä¹ˆéƒ½æ²¡åš', 'ä¸€ç›´æ²¡', 'è¿˜æ˜¯æ²¡', 'æ²¡å¼„', 'æ²¡æ', 'æ²¡è·‘', 'æ²¡çœ‹'],
            anxious: ['ç„¦è™‘', 'å¥½æ…Œ', 'å®³æ€•', 'å‹åŠ›', 'ç´§å¼ ', 'å´©æºƒ', 'å—ä¸äº†', 'çƒ¦èº', 'çƒ¦æ­»', 'ä¸å®‰', 'å¿ƒæ…Œ', 'æ…Œäº†', 'æ€¥æ­»', 'ç€æ€¥', 'æ‹…å¿ƒ', 'æ€•æ¥ä¸åŠ', 'æ¥ä¸åŠ', 'èµ¶ä¸ä¸Š', 'å®Œè›‹'],
            dontWant: ['ä¸æƒ³åš', 'æƒ³æ”¾å¼ƒ', 'åšä¸ä¸‹å»', 'å¤ªéš¾', 'æƒ³é€ƒ', 'æƒ³æ‘†çƒ‚', 'æ‘†äº†', 'ç®—äº†', 'ä¸æƒ³å¹²', 'æƒ³èººå¹³', 'å¥½ç´¯', 'ç´¯æ­»', 'ä¸è¡Œäº†', 'åšæŒä¸ä¸‹å»', 'ä¸æƒ³å†™', 'å†™ä¸ä¸‹å»', 'å¡ä½', 'å¡äº†'],
            needHelp: ['é¼“åŠ±æˆ‘', 'æ‰“æ°”', 'åŠ æ²¹', 'å¸®å¸®æˆ‘', 'æ€ä¹ˆåŠ', 'æ•‘å‘½', 'æ¨æˆ‘ä¸€æŠŠ', 'éª‚æˆ‘', 'æ‰¹è¯„æˆ‘', 'è¯´è¯´æˆ‘', 'å¤¸æˆ‘', 'è¡¨æ‰¬æˆ‘']
        };

        // æ£€æµ‹æ„å›¾
        function detectIntent(text) {
            const t = text.toLowerCase();
            for (const [intent, keywords] of Object.entries(intentPatterns)) {
                if (keywords.some(kw => t.includes(kw))) {
                    return intent;
                }
            }
            return null;
        }

        // è¶…å¤§è¯è¯­åº“ - æ¯ç§åœºæ™¯ç‹¬ç«‹çš„å®Œæ•´å¥å­
        const responses = {
            started: [
                "å¥½ï¼å†²ï¼è¯´åšå°±åšï¼Œè¿™å°±æ˜¯ä½ ï¼",
                "å¤ªå¥½äº†ï¼Œè¡ŒåŠ¨æ´¾ä¸Šçº¿ï¼å»å§ï¼Œæˆ‘ç­‰ä½ çš„å¥½æ¶ˆæ¯~",
                "å‡ºå‘ï¼ä½ å·²ç»æ¯”æ˜¨å¤©çš„è‡ªå·±æ›´å‹‡æ•¢äº†",
                "niceï¼å¼€å§‹äº†å°±æ˜¯æˆåŠŸçš„ä¸€åŠï¼ŒåŠ æ²¹ï¼",
                "å¥½çš„å¥½çš„ï¼Œå¿«å»å¿«å»ï¼åšå®Œäº†è®°å¾—å›æ¥å‘Šè¯‰æˆ‘~",
                "å°±æ˜¯ç°åœ¨ï¼ç›¸ä¿¡è‡ªå·±ï¼Œä½ å¯ä»¥çš„",
                "è¿™å°±å¯¹äº†ï¼åˆ«æƒ³å¤ªå¤šï¼Œå…ˆåšèµ·æ¥ï¼",
                "å‹‡æ•¢ï¼å°±å–œæ¬¢ä½ è¿™æ ·è¯´å¹²å°±å¹²çš„æ ·å­",
                "æ”¶åˆ°ï¼é‚£æˆ‘å°±åœ¨è¿™é‡Œç»™ä½ åŠ æ²¹å•¦ï¼Œå†²å†²å†²ï¼",
                "å¥½ï¼å»å§å»å§ï¼Œé‡åˆ°å›°éš¾éšæ—¶å›æ¥æ‰¾æˆ‘",
                "å¤ªæ£’äº†ï¼ŒåŠ¨èµ·æ¥çš„æ„Ÿè§‰æ˜¯ä¸æ˜¯è¿˜ä¸é”™ï¼Ÿ",
                "yesï¼è¿™æ‰æ˜¯ä½ å‘€ï¼Œè¡ŒåŠ¨åŠ›æ»¡æ»¡ï¼",
                "å¥½çš„ï¼Œé‚£ä½ ä¸“å¿ƒå»åšï¼Œæˆ‘åœ¨è¿™é‡Œç­‰ä½ ~",
                "å‡ºå‡»ï¼ä»Šå¤©çš„ä½ è¶…çº§å‰å®³ï¼",
                "è¿™å°±å»åšäº†ï¼Ÿæˆ‘å°±çŸ¥é“ä½ å¯ä»¥çš„ï¼",
                "å¥½ï¼è®°ä½ï¼Œä¸ç”¨å®Œç¾ï¼Œåšäº†å°±æ˜¯èƒœåˆ©",
                "å†²å‘€ï¼åšä¸€ç‚¹æ˜¯ä¸€ç‚¹ï¼Œåˆ«ç»™è‡ªå·±å¤ªå¤§å‹åŠ›",
                "å¥½å¥½å¥½ï¼Œå¿«å»ï¼æœŸå¾…ä½ åšå®Œå›æ¥æŠ¥å–œ~",
                "çœŸæ£’ï¼è¿ˆå‡ºç¬¬ä¸€æ­¥æ˜¯æœ€éš¾çš„ï¼Œä½ åšåˆ°äº†",
                "å°±æ˜¯è¿™ç§çŠ¶æ€ï¼ä¿æŒä½ï¼Œä½ å¾ˆå‰å®³ï¼"
            ],
            progress: [
                "æœ‰è¿›å±•å°±å¾ˆæ£’å•Šï¼ç»§ç»­ä¿æŒ~",
                "åšäº†ä¸€ç‚¹ä¹Ÿæ˜¯è¿›æ­¥ï¼ä¸€ç‚¹ä¸€ç‚¹æ¥ï¼Œä¸æ€¥",
                "å¾ˆå¥½å¾ˆå¥½ï¼Œåœ¨æ¨è¿›å°±å¯¹äº†ï¼",
                "æ…¢æ…¢æ¥ï¼Œä½ åšå¾—å¾ˆå¥½ï¼Œåˆ«åœä¸‹~",
                "æ¯ä¸€å°æ­¥éƒ½æ˜¯è¿›æ­¥ï¼ç»§ç»­ï¼",
                "åœ¨åŠ¨å°±å¥½ï¼æ¯”åŸåœ°ç„¦è™‘å¼ºä¸€ç™¾å€",
                "ä¸é”™ä¸é”™ï¼Œä¿æŒè¿™ä¸ªèŠ‚å¥~",
                "æœ‰è¿›å±•è¯¶ï¼ä½ çœ‹ï¼Œåšèµ·æ¥å…¶å®æ²¡é‚£ä¹ˆéš¾å¯¹å§",
                "å¾ˆå¥½ï¼åšäº†å°±æ¯”æ²¡åšå¼ºï¼Œç»§ç»­æ¨è¿›å§",
                "ä¸€ç‚¹ä¸€ç‚¹æ¥ï¼Œä½ å·²ç»åœ¨è·¯ä¸Šäº†~",
                "è¿™æ ·å¾ˆå¥½ï¼åˆ«è´ªå¤šï¼Œç¨³æ­¥æ¨è¿›å°±è¡Œ",
                "æœ‰åŠ¨é™å°±å¥½ï¼åŠ æ²¹ï¼Œç»§ç»­~",
                "çœŸä¸é”™ï¼Œåœ¨å¾€å‰èµ°å°±å¯¹äº†ï¼",
                "æ…¢ä¸€ç‚¹æ²¡å…³ç³»ï¼Œé‡è¦çš„æ˜¯åœ¨åš~",
                "è¿›åº¦+1ï¼ä½ å¾ˆæ£’ï¼Œç»§ç»­ä¿æŒè¿™ä¸ªçŠ¶æ€"
            ],
            done: [
                "å¤ªå‰å®³äº†ï¼ï¼æ­å–œå®Œæˆï¼ç»™è‡ªå·±æ”¾ä¸ªçƒŸèŠ±å§ğŸ‰",
                "æå®šäº†ï¼Ÿï¼å¤ªæ£’äº†ï¼ä½ è¶…çº§å‰å®³ï¼",
                "å“‡ï¼å®Œæˆäº†ï¼æˆ‘å°±çŸ¥é“ä½ å¯ä»¥çš„ï¼",
                "æ­å–œæ­å–œï¼ç»ˆäºæå®šäº†ï¼Œå¥½å¥½ä¼‘æ¯ä¸€ä¸‹å§~",
                "è€¶ï¼ä»»åŠ¡å®Œæˆï¼ä½ çœŸçš„å¤ªå‰å®³äº†ï¼",
                "åšå®Œäº†ï¼ï¼ï¼æ’’èŠ±ï¼ä½ æ˜¯æœ€æ£’çš„ï¼",
                "å®Œæˆäº†ï¼Ÿï¼å¿«è®©æˆ‘çœ‹çœ‹è¿™ä¸ªå‰å®³çš„äººï¼",
                "wowï¼ä½ åšåˆ°äº†ï¼æˆ‘å¥½ä¸ºä½ éª„å‚²ï¼",
                "ç»“æŸäº†ï¼è¾›è‹¦äº†ï¼Œä½ çœŸçš„å¾ˆåŠªåŠ›ï¼",
                "å¤ªå¼ºäº†ï¼å®Œæˆçš„æ„Ÿè§‰æ˜¯ä¸æ˜¯è¶…çˆ½ï¼Ÿ",
                "æ­å–œï¼å®Œæˆæ¯”å®Œç¾æ›´é‡è¦ï¼Œä½ åšåˆ°äº†ï¼",
                "æå®šï¼ä»Šå¤©çš„ä½ è¶…çº§æ£’ï¼Œå¥–åŠ±è‡ªå·±ä¸€ä¸‹å§~",
                "å“‡å¡å®Œæˆäº†ï¼ä½ çœ‹ä½ ï¼Œè¯´èƒ½è¡Œå°±çœŸçš„è¡Œï¼",
                "å¥½å‰å®³ï¼å®Œæˆäº†å°±å½»åº•æ”¾æ¾ä¸€ä¸‹å§ï¼Œä½ å€¼å¾—ï¼",
                "åšå®Œäº†ï¼ä¸–ç•Œä¸Šåˆå°‘äº†ä¸€ä»¶è®©ä½ ç„¦è™‘çš„äº‹~"
            ],
            notDone: [
                "æ²¡åšä¹Ÿæ²¡å…³ç³»ï¼Œç°åœ¨å¼€å§‹å°±æ˜¯æœ€å¥½çš„æ—¶æœº~",
                "æ²¡å¼€å§‹ï¼Ÿé‚£å°±ä»ç°åœ¨å¼€å§‹å§ï¼Œå°±ç°åœ¨",
                "å¥½ï¼Œæ²¡åšã€‚é‚£ä¸‹ä¸€ç§’å¯ä»¥å¼€å§‹å—ï¼Ÿè¯•è¯•çœ‹~",
                "ä¸€ç‚¹æ²¡åŠ¨ï¼Ÿæ²¡äº‹ï¼Œå…ˆæ‰“å¼€æ–‡æ¡£ï¼Œå°±æ‰“å¼€è€Œå·²",
                "æ²¡åšå®Œä¸è¦ç´§ï¼Œå…³é”®æ˜¯è¦å¼€å§‹å‘€~",
                "è¿˜æ²¡å¼€å§‹çš„è¯...ä¸å¦‚å…ˆåšæœ€ç®€å•çš„é‚£ä¸€æ­¥ï¼Ÿ",
                "æ²¡åšä¹Ÿæ²¡å…³ç³»å•¦ï¼Œä½†æ˜¯...ä¸€ç›´ä¸åšä¼šæ›´ç„¦è™‘å“¦",
                "okæ²¡åšï¼Œé‚£ç°åœ¨å‘¢ï¼Ÿè¦ä¸è¯•ç€åš5åˆ†é’Ÿï¼Ÿ",
                "æ²¡åŠ¨ï¼Ÿæ·±å‘¼å¸ï¼Œç„¶åæ‰“å¼€å®ƒï¼Œå°±æ‰“å¼€å°±å¥½",
                "è¿˜æ²¡å¼€å§‹ä¹Ÿè¡Œï¼Œä½†åˆ«æ‹–å¤ªä¹…å‘€~",
                "æ²¡å†™ï¼Ÿé‚£å°±ç°åœ¨å†™ç¬¬ä¸€ä¸ªå­—ï¼Ÿè¯•è¯•ï¼Ÿ",
                "å•¥ä¹Ÿæ²¡å¹²ï¼Ÿå¥½å§...é‚£æ¥ä¸‹æ¥å‘¢ï¼Ÿè¦åŠ¨èµ·æ¥å•¦",
                "ä¸€ç›´æ²¡åšï¼Ÿæ²¡å…³ç³»ï¼Œä»è¿™ä¸€åˆ»å¼€å§‹å°±å¥½",
                "æ²¡å¼€å§‹å‘€...é‚£è¦ä¸è¦ç°åœ¨ä¸€èµ·å¼€å§‹ï¼Ÿæˆ‘é™ªä½ ",
                "è¿˜æ²¡åšï¼Ÿæ—¶é—´åœ¨èµ°å“¦~è¦ä¸å…ˆåšä¸€ç‚¹ç‚¹ï¼Ÿ"
            ],
            anxious: [
                "ç„¦è™‘å¾ˆæ­£å¸¸ï¼Œè¯´æ˜ä½ åœ¨ä¹ã€‚ä½†ç„¦è™‘è§£å†³ä¸äº†é—®é¢˜ï¼Œè¡ŒåŠ¨å¯ä»¥~",
                "æˆ‘æ‡‚ï¼Œç„¦è™‘çš„æ—¶å€™è„‘å­ä¸€å›¢ä¹±ã€‚ä½†ç›¸ä¿¡æˆ‘ï¼Œåšèµ·æ¥å°±ä¼šå¥½å¾ˆå¤š",
                "æ…Œä¹Ÿæ²¡ç”¨çš„å‘€~æ·±å‘¼å¸ï¼Œç„¶ååšä¸€ä»¶æœ€å°çš„äº‹æƒ…å¼€å§‹",
                "ç„¦è™‘æ˜¯å› ä¸ºæƒ³å¤ªå¤šåšå¤ªå°‘ã€‚åè¿‡æ¥è¯•è¯•ï¼Ÿåšå¤šä¸€ç‚¹æƒ³å°‘ä¸€ç‚¹",
                "åˆ«æ…Œåˆ«æ…Œï¼Œè¶Šæ…Œè¶Šä¹±ã€‚å…ˆç¨³ä½ï¼Œç„¶ååšä¸€ä»¶äº‹ï¼Œå°±ä¸€ä»¶",
                "å‹åŠ›å¤§çš„æ—¶å€™ï¼ŒæŠŠå¤§ä»»åŠ¡æ‹†æˆå°å—ï¼Œä¸€å—ä¸€å—æ¥~",
                "æˆ‘çŸ¥é“ä½ å¾ˆæ€¥ï¼Œä½†æ˜¯è¶Šæ€¥è¶Šå®¹æ˜“å‡ºé”™ã€‚æ…¢ä¸‹æ¥ï¼Œç¨³ä½",
                "ç„¦è™‘è¯´æ˜ä½ æ˜¯ä¸ªè´Ÿè´£ä»»çš„äººï¼Œä½†ç°åœ¨éœ€è¦çš„æ˜¯è¡ŒåŠ¨è€Œä¸æ˜¯æ‹…å¿ƒ",
                "å®³æ€•æ¥ä¸åŠï¼Ÿé‚£å°±ç°åœ¨å¼€å§‹å‘€ï¼Œæ¯ä¸€ç§’éƒ½åœ¨å€’è®¡æ—¶å“¦",
                "ç´§å¼ çš„è¯...è¯•è¯•å…ˆåš10åˆ†é’Ÿï¼Ÿåšå®Œå¯èƒ½å°±ä¸ç´§å¼ äº†",
                "å‹åŠ›å¤§å°±å…ˆåšå‹åŠ›æœ€å°çš„é‚£éƒ¨åˆ†ï¼Œæ…¢æ…¢æ¥~",
                "å¿ƒæ…Œçš„æ—¶å€™ï¼Œå°±åšçœ¼å‰æœ€ç®€å•çš„ä¸€æ­¥ï¼Œåˆ«æƒ³å¤ªè¿œ",
                "ç„¦è™‘â‰ è§£å†³é—®é¢˜ã€‚æŠŠç„¦è™‘çš„æ—¶é—´ç”¨æ¥åšäº‹ï¼Œä¼šå¥½å¾ˆå¤š~",
                "å—ä¸äº†ï¼Ÿé‚£å°±å¯¹äº†ï¼Œè¯´æ˜è¯¥è¡ŒåŠ¨äº†ã€‚å»åšå§ï¼",
                "æˆ‘ç†è§£ä½ çš„ç„¦è™‘ï¼Œä½†å”¯ä¸€çš„è§£è¯å°±æ˜¯ï¼šå¼€å§‹åš"
            ],
            dontWant: [
                "ä¸æƒ³åšä¹Ÿå¾—åšå‘€...ä¸–ç•Œä¸Šå“ªæœ‰é‚£ä¹ˆå¤šæƒ³åšçš„äº‹",
                "ç´¯äº†å°±ä¼‘æ¯ä¸€ä¼šå„¿ï¼Œä½†ä¼‘æ¯å®Œäº†è¦ç»§ç»­å“¦~",
                "æƒ³æ”¾å¼ƒï¼Ÿå…ˆåˆ«ï¼Œå†åšæŒä¸€ä¸‹ä¸‹ï¼Œè¯´ä¸å®šå°±è¿‡å»äº†",
                "åšä¸ä¸‹å»ï¼Ÿé‚£ä¼‘æ¯10åˆ†é’Ÿï¼Œç„¶åå›æ¥ç»§ç»­ï¼",
                "å¤ªéš¾äº†æ˜¯å§...æŠŠå®ƒåˆ†æˆå°å—ï¼Œä¸€å—ä¸€å—å•ƒ",
                "æƒ³èººå¹³ï¼Ÿèººä¸€ä¼šå„¿å¯ä»¥ï¼Œä½†åˆ«èººå¤ªä¹…~",
                "å¥½ç´¯æˆ‘æ‡‚ï¼Œä½†åšå®Œæ‰èƒ½çœŸæ­£è½»æ¾å‘€",
                "ä¸æƒ³å¹²ä¹Ÿæ­£å¸¸ï¼Œä½†æ‹–ç€ä¼šæ›´ä¸æƒ³å¹²ï¼Œè¶ç°åœ¨è¿˜æœ‰ç‚¹åŠ¨åŠ›ï¼Ÿ",
                "æƒ³æ‘†çƒ‚ï¼Ÿä¸è¡Œï¼ä½ æ¯”ä½ æƒ³è±¡çš„æ›´èƒ½åšæŒï¼",
                "åšæŒä¸ä¸‹å»ï¼Ÿé‚£å°±é™ä½æ ‡å‡†ï¼Œå…ˆå®Œæˆå†è¯´å®Œç¾",
                "æƒ³é€ƒï¼Ÿé€ƒä¸æ‰çš„å‘€...ä¸å¦‚é¢å¯¹å®ƒï¼Œå¹²æ‰å®ƒ",
                "æˆ‘çŸ¥é“å¾ˆéš¾ï¼Œä½†ä½ å·²ç»èµ°äº†è¿™ä¹ˆè¿œäº†ï¼Œåˆ«æ”¾å¼ƒ",
                "ä¸è¡Œäº†ï¼Ÿä¼‘æ¯ä¸€ä¸‹ï¼Œå–å£æ°´ï¼Œç„¶åç»§ç»­ã€‚ä½ å¯ä»¥çš„",
                "æƒ³æ”¾å¼ƒå¾ˆæ­£å¸¸ï¼Œä½†æ”¾å¼ƒä¹‹åå‘¢ï¼Ÿè¿˜æ˜¯å¾—åšå§ï¼Ÿ",
                "å¤ªéš¾çš„è¯ï¼Œå…ˆåšæœ€ç®€å•çš„é‚£1%ï¼Œå‰©ä¸‹çš„å†è¯´"
            ],
            needHelp: [
                "ä½ å¾ˆæ£’ï¼Œä½ å¯ä»¥çš„ï¼Œä½ æ¯”è‡ªå·±æƒ³è±¡çš„æ›´å‰å®³ï¼å»åšå§ï¼",
                "æ¥ï¼Œæˆ‘æ¨ä½ ä¸€æŠŠï¼šç°åœ¨ç«‹åˆ»é©¬ä¸Šå»åšï¼ä¸è¦æƒ³äº†ï¼",
                "åŠ æ²¹åŠ æ²¹åŠ æ²¹ï¼ä½ æ˜¯æœ€æ£’çš„ï¼å†²ï¼",
                "å¥½ï¼Œæˆ‘æ¥éª‚ä½ ï¼šè¿˜ä¸å»åšï¼Ÿç£¨è¹­ä»€ä¹ˆå‘¢ï¼å¿«å»ï¼",
                "æˆ‘ç›¸ä¿¡ä½ ï¼ä½ ä¸€å®šå¯ä»¥çš„ï¼ç°åœ¨å°±å»è¯æ˜ç»™è‡ªå·±çœ‹ï¼",
                "æ‰“æ°”æ—¶é—´åˆ°ï¼šä½ å¾ˆå‰å®³ï¼Œè¿™ç‚¹äº‹éš¾ä¸å€’ä½ çš„ï¼",
                "æ€ä¹ˆåŠï¼Ÿåšå°±å¯¹äº†ï¼æƒ³å¤ªå¤šæ²¡ç”¨çš„ï¼Œå†²å°±å®Œäº‹äº†ï¼",
                "æˆ‘æ¥æ¨ä½ ï¼šå…³æ‰è¿™ä¸ªå¯¹è¯ï¼Œå»åšä½ è¯¥åšçš„äº‹ï¼ç°åœ¨ï¼",
                "ä½ éœ€è¦çš„ä¸æ˜¯é¼“åŠ±ï¼Œæ˜¯è¡ŒåŠ¨ã€‚å»å§ï¼Œåšå®Œå†æ¥æ‰¾æˆ‘ï¼",
                "æ•‘å‘½ï¼Ÿæˆ‘æ¥æ•‘ä½ ï¼šåœæ­¢ç„¦è™‘ï¼Œå¼€å§‹åšï¼è¿™å°±æ˜¯æ–¹æ³•ï¼",
                "å¥½ï¼Œæ‰¹è¯„ä½ ï¼šæ‹–å»¶è¿™ä¹ˆä¹…äº†ï¼Œå†ä¸åšå°±çœŸçš„æ¥ä¸åŠäº†ï¼",
                "åŠ æ²¹ï¼ä½ èƒ½è¡Œçš„ï¼æˆ‘åœ¨è¿™é‡Œç»™ä½ æ‰“callï¼",
                "è¯´çœŸçš„ï¼Œä½ å·²ç»å¾ˆåŠªåŠ›äº†ï¼Œå†åšæŒä¸€ä¸‹å°±å¥½äº†ï¼",
                "æˆ‘å¯¹ä½ æœ‰ä¿¡å¿ƒï¼ä½ è‚¯å®šå¯ä»¥æå®šçš„ï¼å»å§ï¼",
                "åˆ«æ€•ï¼åšé”™äº†ä¹Ÿæ¯”ä¸åšå¼ºï¼å†²å°±å¯¹äº†ï¼"
            ]
        };

        // æ—¶é—´ç›¸å…³çš„å¼€å¤´ï¼ˆå¯é€‰æ·»åŠ ï¼‰
        const timeOpeners = {
            earlyMorning: ["ä¸€å¤§æ—©å°±åœ¨åŠªåŠ›ï¼", "æ—©èµ·çš„ä½ çœŸæ£’ï¼", "è¿™ä¹ˆæ—©å°±å¼€å§‹å•¦ï¼Ÿ"],
            morning: ["ä¸Šåˆå¥½å‘€~", ""],
            noon: ["ä¸­åˆäº†ï¼Œ", "åˆé¥­åƒäº†å—ï¼Ÿ"],
            afternoon: ["ä¸‹åˆå•¦~", ""],
            evening: ["æ™šä¸Šäº†ï¼Œ", "è¾›è‹¦ä¸€å¤©äº†ï¼Œ"],
            lateNight: ["è¿™ä¹ˆæ™šè¿˜åœ¨å¿™ï¼Ÿ", "å¤œæ·±äº†ï¼Œ", "æ³¨æ„ä¼‘æ¯å“¦ï¼Œ"]
        };

        // è·å–éšæœºå›å¤
        function getResponse(intent, taskName) {
            const pool = responses[intent];
            if (!pool || pool.length === 0) return null;
            
            let response = pool[Math.floor(Math.random() * pool.length)];
            
            // 20%æ¦‚ç‡åŠ æ—¶é—´å¼€å¤´
            const timeCtx = getTimeContext();
            if (Math.random() < 0.2 && timeOpeners[timeCtx.period]) {
                const openers = timeOpeners[timeCtx.period].filter(o => o);
                if (openers.length > 0) {
                    response = openers[Math.floor(Math.random() * openers.length)] + response;
                }
            }
            
            return response;
        }

        // åŸºç¡€é¼“åŠ±ï¼ˆæ— ç‰¹å®šæ„å›¾æ—¶ï¼‰
        const generalEncouragements = [
            "æœ‰ä»€ä¹ˆæƒ³è¯´çš„ï¼Œéšæ—¶å‘Šè¯‰æˆ‘~",
            "æˆ‘åœ¨è¿™é‡Œé™ªç€ä½ ~",
            "åŠ æ²¹ï¼Œä½ å¯ä»¥çš„ï¼",
            "æ…¢æ…¢æ¥ï¼Œä¸æ€¥~"
        ];

        function randomPick(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Track anxiety reports to escalate response
        let anxietyCount = parseInt(localStorage.getItem('qqqq_anxiety_count') || '0');

        // ==================== Priority Algorithm ====================
        function calculateTaskScore(task) {
            if (task.completed) return -1000;
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let score = 0;

            // Deadline urgency
            if (task.date) {
                const deadline = new Date(task.date);
                const daysLeft = Math.floor((deadline - today) / (1000 * 60 * 60 * 24));
                
                if (daysLeft < 0) score += 500; // Overdue
                else if (daysLeft === 0) score += 400; // Today
                else if (daysLeft === 1) score += 300; // Tomorrow
                else if (daysLeft <= 3) score += 200; // Within 3 days
                else if (daysLeft <= 7) score += 100; // Within a week
            }

            // User priority
            if (task.priority === 'high') score += 150;
            else if (task.priority === 'medium') score += 50;
            else if (task.priority === 'low') score += 10;

            // Not started tasks get slight boost
            if (!task.started) score += 20;

            return score;
        }

        function getTopTask() {
            const pending = tasks.filter(t => !t.completed);
            if (pending.length === 0) return null;
            
            pending.sort((a, b) => calculateTaskScore(b) - calculateTaskScore(a));
            return pending[0];
        }

        function getTaskUrgencyLabel(task) {
            if (!task.date) return { text: 'æ— æˆªæ­¢æ—¥æœŸ', class: '' };
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const deadline = new Date(task.date);
            const daysLeft = Math.floor((deadline - today) / (1000 * 60 * 60 * 24));

            if (daysLeft < 0) return { text: `å·²è¿‡æœŸ${-daysLeft}å¤©`, class: 'urgent' };
            if (daysLeft === 0) return { text: 'ä»Šå¤©æˆªæ­¢', class: 'urgent' };
            if (daysLeft === 1) return { text: 'æ˜å¤©æˆªæ­¢', class: 'soon' };
            if (daysLeft <= 3) return { text: `è¿˜å‰©${daysLeft}å¤©`, class: 'soon' };
            return { text: `è¿˜å‰©${daysLeft}å¤©`, class: '' };
        }

        // ==================== Reminder Frequency ====================
        function shouldShowReminder() {
            const topTask = getTopTask();
            if (!topTask || !topTask.date) return false;

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const deadline = new Date(topTask.date);
            const daysLeft = Math.floor((deadline - today) / (1000 * 60 * 60 * 24));

            const lastCheck = appState.lastProgressCheck ? new Date(appState.lastProgressCheck) : null;
            const hoursSinceCheck = lastCheck ? (now - lastCheck) / (1000 * 60 * 60) : 999;

            // Frequency based on urgency
            if (daysLeft <= 1) return hoursSinceCheck >= 3; // Every 3 hours
            if (daysLeft <= 3) return hoursSinceCheck >= 6; // Every 6 hours
            if (daysLeft <= 7) return hoursSinceCheck >= 12; // Twice a day
            return hoursSinceCheck >= 24; // Once a day
        }

        // ==================== DOM Elements ====================
        const $ = id => document.getElementById(id);

        // ==================== Theme ====================
        const savedTheme = localStorage.getItem('qqqq_theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            $('themeToggle').textContent = 'ğŸŒ™';
            $('darkModeToggle').classList.add('active');
        }

        function toggleTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                $('themeToggle').textContent = 'â˜€ï¸';
                $('darkModeToggle').classList.remove('active');
                localStorage.setItem('qqqq_theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                $('themeToggle').textContent = 'ğŸŒ™';
                $('darkModeToggle').classList.add('active');
                localStorage.setItem('qqqq_theme', 'dark');
            }
        }

        $('themeToggle').onclick = toggleTheme;
        $('darkModeToggle').onclick = toggleTheme;

        // ==================== Navigation ====================
        document.querySelectorAll('.nav-item').forEach(item => {
            item.onclick = () => {
                const page = item.dataset.page;
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                $(`${page}Page`).classList.add('active');

                if (page === 'snippets') {
                    $('chatInputArea').style.display = 'none';
                    $('addBtn').classList.add('visible');
                } else if (page === 'settings') {
                    $('chatInputArea').style.display = 'none';
                    $('addBtn').classList.remove('visible');
                } else {
                    $('chatInputArea').style.display = 'block';
                    $('addBtn').classList.remove('visible');
                }
            };
        });

        // Task Tabs
        document.querySelectorAll('.task-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.task-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                
                $('pendingSection').style.display = currentTab === 'pending' ? 'block' : 'none';
                $('completedSection').style.display = currentTab === 'completed' ? 'block' : 'none';
            };
        });

        // ==================== Input Handling ====================
        const chatInput = $('chatInput');
        chatInput.oninput = function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        };

        const timePatterns = [
            { regex: /ä»Šå¤©|ä»Šæ—¥/i, days: 0 },
            { regex: /æ˜å¤©|æ˜æ—¥/i, days: 1 },
            { regex: /åå¤©/i, days: 2 },
            { regex: /å¤§åå¤©/i, days: 3 },
            { regex: /ä¸‹å‘¨|ä¸‹æ˜ŸæœŸ/i, days: 7 },
            { regex: /(\d{1,2})[æœˆ\-\/](\d{1,2})[æ—¥å·]?/i, type: 'date' },
            { regex: /(\d{1,2})[ç‚¹æ—¶:](\d{0,2})/i, type: 'time' },
        ];

        const taskKeywords = ['è®°å¾—', 'è¦', 'éœ€è¦', 'å¿…é¡»', 'æé†’', 'åˆ«å¿˜', 'æˆªæ­¢', 'deadline', 'äº¤', 'å®Œæˆ', 'åš', 'å»', 'ä¹°', 'å¼€ä¼š', 'ç»„ä¼š', 'æ±‡æŠ¥', 'ç­”è¾©', 'é¢è¯•', 'å‘¨'];

        function recognizeInput(text) {
            const looksLikeTask = taskKeywords.some(kw => text.includes(kw));
            let recognizedDate = null;
            let recognizedTime = null;
            let hints = [];

            for (const pattern of timePatterns) {
                const match = text.match(pattern.regex);
                if (match) {
                    if (pattern.days !== undefined) {
                        const date = new Date();
                        date.setDate(date.getDate() + pattern.days);
                        recognizedDate = date.toISOString().split('T')[0];
                        hints.push(match[0]);
                    } else if (pattern.type === 'date') {
                        const now = new Date();
                        const month = parseInt(match[1]) - 1;
                        const day = parseInt(match[2]);
                        const year = month < now.getMonth() ? now.getFullYear() + 1 : now.getFullYear();
                        recognizedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        hints.push(match[0]);
                    } else if (pattern.type === 'time') {
                        let hour = parseInt(match[1]);
                        const minute = match[2] ? parseInt(match[2]) : 0;
                        if (text.match(/ä¸‹åˆ|æ™šä¸Š/) && hour < 12) hour += 12;
                        recognizedTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                        hints.push(match[0]);
                    }
                }
            }

            return {
                isTask: looksLikeTask || recognizedDate || recognizedTime,
                date: recognizedDate,
                time: recognizedTime,
                hints: hints.length > 0 ? `æ£€æµ‹åˆ° ${hints.join('ã€')}` : null
            };
        }

        function handleSend() {
            const text = chatInput.value.trim();
            if (!text) return;

            // é¦–å…ˆæ£€æµ‹æ˜¯å¦æ˜¯æ±‡æŠ¥ç±»æ„å›¾
            const intent = detectIntent(text);
            
            if (intent) {
                // æ˜¯æ±‡æŠ¥ï¼Œç»™å‡ºå›åº”
                const topTask = getTopTask();
                const taskName = topTask ? topTask.text : null;
                const response = getResponse(intent, taskName);
                
                // æ ¹æ®æ„å›¾ç±»å‹å†³å®šåé¦ˆæ ·å¼
                let feedbackClass = 'feedback-message active';
                if (intent === 'done') {
                    feedbackClass = 'feedback-message active'; // åº†ç¥
                    if (topTask) {
                        toggleTask(topTask.id); // è‡ªåŠ¨å®Œæˆä»»åŠ¡
                    }
                } else if (intent === 'started' || intent === 'progress') {
                    feedbackClass = 'feedback-message active';
                    if (topTask && intent === 'started') {
                        markTaskStarted(topTask.id);
                    }
                    anxietyCount = 0;
                    localStorage.setItem('qqqq_anxiety_count', '0');
                } else if (intent === 'notDone' || intent === 'anxious' || intent === 'dontWant') {
                    feedbackClass = 'feedback-message gentle active';
                    anxietyCount++;
                    localStorage.setItem('qqqq_anxiety_count', anxietyCount.toString());
                } else if (intent === 'needHelp') {
                    feedbackClass = 'feedback-message active';
                }
                
                $('feedbackMessage').className = feedbackClass;
                $('feedbackText').textContent = response;
                
                // æ ¹æ®å†…å®¹é•¿åº¦è°ƒæ•´æ˜¾ç¤ºæ—¶é—´
                const displayTime = Math.max(4000, response.length * 100);
                setTimeout(() => $('feedbackMessage').classList.remove('active'), displayTime);
                
                chatInput.value = '';
                chatInput.style.height = 'auto';
                return;
            }

            // ä¸æ˜¯æ±‡æŠ¥ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ä»»åŠ¡
            const rec = recognizeInput(text);
            
            if (rec.isTask) {
                pendingTaskText = text;
                let msg = 'è¿™çœ‹èµ·æ¥æ˜¯ä¸ªä»»åŠ¡~';
                if (rec.hints) msg += `<br><strong>${rec.hints}</strong>`;
                $('recognitionText').innerHTML = msg;
                
                $('taskTitleInput').value = text;
                if (rec.date) $('taskDateInput').value = rec.date;
                if (rec.time) $('taskTimeInput').value = rec.time;
                
                $('recognitionPopup').classList.add('active');
            } else {
                addTask(text, null, null, 'medium');
                showToast('å·²è®°å½• âœ“');
            }
            
            chatInput.value = '';
            chatInput.style.height = 'auto';
        }

        $('sendBtn').onclick = handleSend;
        chatInput.onkeydown = e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        };

        $('recognitionConfirm').onclick = () => {
            $('recognitionPopup').classList.remove('active');
            $('taskModal').classList.add('active');
        };

        $('recognitionCancel').onclick = () => {
            $('recognitionPopup').classList.remove('active');
            addTask(pendingTaskText, null, null, 'medium');
            showToast('å·²è®°å½• âœ“');
        };

        // ==================== Task CRUD ====================
        function addTask(text, date, time, priority) {
            const task = {
                id: Date.now(),
                text,
                date,
                time,
                priority,
                completed: false,
                started: false,
                createdAt: new Date().toISOString()
            };
            tasks.unshift(task);
            saveTasks();
            renderTasks();
        }

        function toggleTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.completedAt = new Date().toISOString();
                }
                saveTasks();
                renderTasks();
                if (task.completed) {
                    showToast('å®Œæˆäº†ï¼ä½ çœŸæ£’~ ğŸ‰');
                }
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            saveTasks();
            renderTasks();
            showToast('å·²åˆ é™¤');
        }

        function markTaskStarted(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.started = true;
                saveTasks();
            }
        }

        function saveTasks() {
            localStorage.setItem('qqqq_tasks', JSON.stringify(tasks));
        }

        // ==================== Reminder Schedule Generator ====================
        function generateReminderSchedule(taskText, deadlineDate) {
            if (!deadlineDate) return null;
            
            const deadline = new Date(deadlineDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            deadline.setHours(0, 0, 0, 0);
            
            const daysLeft = Math.floor((deadline - today) / (1000 * 60 * 60 * 24));
            if (daysLeft < 0) return null; // å·²è¿‡æœŸ
            
            const reminders = [];
            const formatDate = (d) => `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
            
            if (daysLeft === 0) {
                // ä»Šå¤©æˆªæ­¢ï¼šæé†’3æ¬¡
                reminders.push({ date: formatDate(today), times: ['9:00', '14:00', '18:00'], label: 'ä»Šå¤©æˆªæ­¢ï¼' });
            } else if (daysLeft === 1) {
                // æ˜å¤©æˆªæ­¢
                reminders.push({ date: formatDate(today), times: ['9:00', '20:00'], label: 'è¿˜å‰©1å¤©' });
                const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
                reminders.push({ date: formatDate(tomorrow), times: ['9:00', '12:00', '17:00'], label: 'ä»Šå¤©æˆªæ­¢ï¼' });
            } else if (daysLeft <= 3) {
                // 2-3å¤©ï¼šæ¯å¤©2æ¬¡
                for (let i = 0; i <= daysLeft; i++) {
                    const d = new Date(today); d.setDate(d.getDate() + i);
                    const left = daysLeft - i;
                    if (left === 0) {
                        reminders.push({ date: formatDate(d), times: ['9:00', '14:00', '18:00'], label: 'ä»Šå¤©æˆªæ­¢ï¼' });
                    } else {
                        reminders.push({ date: formatDate(d), times: ['9:00', '20:00'], label: `è¿˜å‰©${left}å¤©` });
                    }
                }
            } else if (daysLeft <= 7) {
                // 4-7å¤©ï¼šå‰å‡ å¤©æ¯å¤©1æ¬¡ï¼Œå3å¤©æ¯å¤©2æ¬¡
                for (let i = 0; i <= daysLeft; i++) {
                    const d = new Date(today); d.setDate(d.getDate() + i);
                    const left = daysLeft - i;
                    if (left === 0) {
                        reminders.push({ date: formatDate(d), times: ['9:00', '14:00', '18:00'], label: 'ä»Šå¤©æˆªæ­¢ï¼' });
                    } else if (left <= 2) {
                        reminders.push({ date: formatDate(d), times: ['9:00', '20:00'], label: `è¿˜å‰©${left}å¤©` });
                    } else {
                        reminders.push({ date: formatDate(d), times: ['9:00'], label: `è¿˜å‰©${left}å¤©` });
                    }
                }
            } else {
                // è¶…è¿‡7å¤©ï¼šæ¯2å¤©æé†’ä¸€æ¬¡ï¼Œæœ€å3å¤©åŠ å¯†
                for (let i = 0; i <= daysLeft; i++) {
                    const d = new Date(today); d.setDate(d.getDate() + i);
                    const left = daysLeft - i;
                    if (left === 0) {
                        reminders.push({ date: formatDate(d), times: ['9:00', '14:00', '18:00'], label: 'ä»Šå¤©æˆªæ­¢ï¼' });
                    } else if (left <= 2) {
                        reminders.push({ date: formatDate(d), times: ['9:00', '20:00'], label: `è¿˜å‰©${left}å¤©` });
                    } else if (left <= 5) {
                        reminders.push({ date: formatDate(d), times: ['9:00'], label: `è¿˜å‰©${left}å¤©` });
                    } else if (i % 2 === 0) {
                        reminders.push({ date: formatDate(d), times: ['9:00'], label: `è¿˜å‰©${left}å¤©` });
                    }
                }
            }
            
            return { taskText, reminders };
        }

        function formatRemindersForCopy(schedule) {
            if (!schedule) return '';
            
            let text = `ğŸ“Œ ä»»åŠ¡ï¼š${schedule.taskText}\n\n`;
            text += `â° æé†’æ—¶é—´è¡¨ï¼š\n`;
            
            schedule.reminders.forEach(r => {
                text += `\n${r.date}ï¼ˆ${r.label}ï¼‰\n`;
                r.times.forEach(t => {
                    text += `  Â· ${t} æé†’\n`;
                });
            });
            
            text += `\nğŸ’¡ å¤åˆ¶æ¯æ¡åˆ°ã€Œæé†’äº‹é¡¹ã€è®¾ç½®å¯¹åº”æ—¶é—´`;
            return text;
        }

        function showReminderModal(taskText, deadlineDate) {
            const schedule = generateReminderSchedule(taskText, deadlineDate);
            if (!schedule || schedule.reminders.length === 0) return;
            
            // æ¸²æŸ“æ—¶é—´è¡¨
            let html = '';
            schedule.reminders.forEach(r => {
                html += `
                    <div class="reminder-item">
                        <span class="reminder-date">${r.date}</span>
                        <span class="reminder-times">${r.label} â†’ ${r.times.join('ã€')}</span>
                    </div>
                `;
            });
            
            // æ·»åŠ å¤åˆ¶é¢„è§ˆ
            const copyText = formatRemindersForCopy(schedule);
            html += `<div class="reminder-text-preview">${escapeHtml(copyText)}</div>`;
            
            $('reminderSchedule').innerHTML = html;
            $('reminderSchedule').dataset.copyText = copyText;
            $('reminderTip').classList.remove('active');
            $('copyAllReminders').textContent = 'ğŸ“‹ ä¸€é”®å¤åˆ¶å…¨éƒ¨';
            $('copyAllReminders').style.background = '';
            $('reminderModal').classList.add('active');
        }

        $('copyAllReminders').onclick = () => {
            const text = $('reminderSchedule').dataset.copyText;
            navigator.clipboard.writeText(text).then(() => {
                showToast('å·²å¤åˆ¶ï¼');
                $('reminderTip').classList.add('active');
                $('copyAllReminders').textContent = 'âœ… å·²å¤åˆ¶';
                $('copyAllReminders').style.background = 'var(--success)';
            });
        };

        $('closeReminderModal').onclick = () => $('reminderModal').classList.remove('active');
        $('skipReminder').onclick = () => $('reminderModal').classList.remove('active');

        function saveState() {
            localStorage.setItem('qqqq_state', JSON.stringify(appState));
        }

        // ==================== Render Tasks ====================
        function renderTasks() {
            const pending = tasks.filter(t => !t.completed);
            const completed = tasks.filter(t => t.completed);

            // Sort pending by score
            pending.sort((a, b) => calculateTaskScore(b) - calculateTaskScore(a));
            // Sort completed by completion time
            completed.sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));

            $('pendingCount').textContent = pending.length;
            $('completedCount').textContent = completed.length;

            // Render lists
            $('pendingTaskList').innerHTML = pending.map((t, i) => createTaskHTML(t, i + 1)).join('');
            $('completedTaskList').innerHTML = completed.map(t => createTaskHTML(t)).join('');

            // Empty states
            $('emptyPending').style.display = pending.length === 0 ? 'block' : 'none';
            $('emptyCompleted').style.display = completed.length === 0 ? 'block' : 'none';

            // Priority card
            const topTask = getTopTask();
            if (topTask) {
                $('priorityCard').style.display = 'block';
                $('encouragement').style.display = 'none';
                $('priorityTaskText').textContent = topTask.text;
                
                const urgency = getTaskUrgencyLabel(topTask);
                const priorityLabels = { high: 'é«˜ä¼˜å…ˆçº§', medium: '', low: '' };
                let metaText = urgency.text;
                if (priorityLabels[topTask.priority]) {
                    metaText += ` Â· ${priorityLabels[topTask.priority]}`;
                }
                $('priorityMeta').innerHTML = `<span class="${urgency.class}">${metaText}</span>`;
                
                // çŠ¶æ€æç¤º
                $('priorityStatus').innerHTML = topTask.started 
                    ? 'âœ… å·²å¼€å§‹ Â· åœ¨ä¸‹æ–¹å‘Šè¯‰æˆ‘è¿›åº¦å§~' 
                    : 'ğŸ’¬ åœ¨ä¸‹æ–¹è¾“å…¥æ¡†å‘Šè¯‰æˆ‘ï¼šå¼€å§‹äº†å—ï¼Ÿåšå®Œäº†å—ï¼Ÿæˆ–è€…...ç„¦è™‘äº†ï¼Ÿ';
            } else {
                $('priorityCard').style.display = 'none';
                $('encouragement').style.display = 'block';
                $('encouragementText').textContent = "æ²¡æœ‰å¾…åŠäº‹é¡¹ï¼Œäº«å—è¿™ä»½è½»æ¾å§~";
            }

            // Update reminder banner
            updateReminderBanner();
        }

        function createTaskHTML(task, rank) {
            const urgency = getTaskUrgencyLabel(task);
            const timeLabel = task.time || '';
            
            return `
                <div class="task-card ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
                    <div class="task-content">
                        <div class="task-text">${escapeHtml(task.text)}</div>
                        <div class="task-meta">
                            ${!task.completed && rank && rank <= 3 ? `<span class="task-rank">ç¬¬${rank}ä¼˜å…ˆ</span>` : ''}
                            ${task.date ? `<span class="task-time ${urgency.class}">${urgency.text}${timeLabel ? ' ' + timeLabel : ''}</span>` : ''}
                        </div>
                    </div>
                    <button class="task-delete" onclick="deleteTask(${task.id})">âœ•</button>
                </div>
            `;
        }

        function updateReminderBanner() {
            const topTask = getTopTask();
            if (!topTask) {
                $('reminderBanner').classList.remove('active');
                return;
            }

            const urgency = getTaskUrgencyLabel(topTask);
            if (urgency.class === 'urgent' || urgency.class === 'soon') {
                $('reminderBanner').classList.add('active');
                $('reminderText').textContent = urgency.class === 'urgent' 
                    ? randomPick(encouragements.urgent)
                    : randomPick(encouragements.reminder);
            } else {
                $('reminderBanner').classList.remove('active');
            }
        }

        // ==================== Progress Dialog ====================
        function showProgressDialog() {
            const topTask = getTopTask();
            if (!topTask) return;

            $('progressQuestion').textContent = 'è¿™ä¸ªä»»åŠ¡å¼€å§‹äº†å—ï¼Ÿ';
            $('progressTaskName').textContent = topTask.text;
            $('progressDialog').classList.add('active');
            $('progressDialog').dataset.taskId = topTask.id;

            appState.lastProgressCheck = new Date().toISOString();
            saveState();
        }

        $('progressYes').onclick = () => {
            const taskId = parseInt($('progressDialog').dataset.taskId);
            markTaskStarted(taskId);
            $('progressDialog').classList.remove('active');
            
            $('feedbackMessage').className = 'feedback-message active';
            $('feedbackText').textContent = getResponse('started');
            
            setTimeout(() => {
                $('feedbackMessage').classList.remove('active');
            }, 5000);
        };

        $('progressNo').onclick = () => {
            $('progressDialog').classList.remove('active');
            
            $('feedbackMessage').className = 'feedback-message gentle active';
            $('feedbackText').textContent = getResponse('notDone');
            
            setTimeout(() => {
                $('feedbackMessage').classList.remove('active');
            }, 6000);
        };

        // ==================== Task Modal ====================
        $('closeTaskModal').onclick = () => $('taskModal').classList.remove('active');

        document.querySelectorAll('.priority-option').forEach(opt => {
            opt.onclick = () => {
                document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
            };
        });

        $('saveTaskBtn').onclick = () => {
            const text = $('taskTitleInput').value.trim();
            if (!text) return;
            
            const date = $('taskDateInput').value || null;
            const time = $('taskTimeInput').value || null;
            const priority = document.querySelector('.priority-option.selected').dataset.priority;
            
            addTask(text, date, time, priority);
            
            $('taskTitleInput').value = '';
            $('taskDateInput').value = '';
            $('taskTimeInput').value = '';
            document.querySelectorAll('.priority-option').forEach(o => o.classList.remove('selected'));
            document.querySelector('.priority-option[data-priority="medium"]').classList.add('selected');
            
            $('taskModal').classList.remove('active');
            showToast('ä»»åŠ¡å·²æ·»åŠ  âœ“');
            
            // å¦‚æœæœ‰æˆªæ­¢æ—¥æœŸï¼Œå¼¹å‡ºæé†’è®¾ç½®
            if (date) {
                setTimeout(() => {
                    showReminderModal(text, date);
                }, 500);
            }
        };

        // ==================== Snippets ====================
        function addSnippet(title, content, category, tags) {
            snippets.unshift({
                id: Date.now(),
                title, content, category,
                tags: tags.filter(t => t),
                createdAt: new Date().toISOString()
            });
            saveSnippets();
            renderSnippets();
        }

        function updateSnippet(id, title, content, category, tags) {
            const s = snippets.find(s => s.id === id);
            if (s) {
                s.title = title;
                s.content = content;
                s.category = category;
                s.tags = tags.filter(t => t);
                saveSnippets();
                renderSnippets();
            }
        }

        function deleteSnippet(id) {
            snippets = snippets.filter(s => s.id !== id);
            saveSnippets();
            renderSnippets();
            showToast('å·²åˆ é™¤');
        }

        function copySnippet(id) {
            const s = snippets.find(s => s.id === id);
            if (s) {
                navigator.clipboard.writeText(s.content).then(() => showToast('å·²å¤åˆ¶ âœ“'));
            }
        }

        function editSnippet(id) {
            const s = snippets.find(s => s.id === id);
            if (s) {
                editingSnippetId = id;
                $('snippetModalTitle').textContent = 'ç¼–è¾‘ç‰‡æ®µ';
                $('snippetTitleInput').value = s.title;
                $('snippetContentInput').value = s.content;
                $('snippetCategorySelect').value = s.category;
                $('snippetTagsInput').value = s.tags.join(' ');
                $('snippetModal').classList.add('active');
            }
        }

        function saveSnippets() {
            localStorage.setItem('qqqq_snippets', JSON.stringify(snippets));
        }

        function renderSnippets() {
            const search = $('snippetSearch').value.toLowerCase();
            let filtered = snippets;
            
            if (currentCategory !== 'all') {
                filtered = filtered.filter(s => s.category === currentCategory);
            }
            if (search) {
                filtered = filtered.filter(s => 
                    s.title.toLowerCase().includes(search) ||
                    s.content.toLowerCase().includes(search) ||
                    s.tags.some(t => t.toLowerCase().includes(search))
                );
            }

            const icons = { academic: 'ğŸ“š', ai: 'ğŸ¤–', account: 'ğŸ”', template: 'ğŸ“‹', other: 'ğŸ’¬' };
            
            $('snippetList').innerHTML = filtered.map(s => `
                <div class="snippet-card">
                    <div class="snippet-header">
                        <div class="snippet-title">${icons[s.category]} ${escapeHtml(s.title)}</div>
                        <div class="snippet-actions">
                            <button class="snippet-btn copy-btn" onclick="copySnippet(${s.id})">ğŸ“‹</button>
                            <button class="snippet-btn" onclick="editSnippet(${s.id})">âœï¸</button>
                            <button class="snippet-btn delete-btn" onclick="deleteSnippet(${s.id})">ğŸ—‘</button>
                        </div>
                    </div>
                    <div class="snippet-content">${escapeHtml(s.content)}</div>
                    ${s.tags.length ? `<div class="snippet-tags">${s.tags.map(t => `<span class="snippet-tag">#${escapeHtml(t)}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');

            $('emptySnippets').style.display = filtered.length === 0 ? 'block' : 'none';
        }

        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentCategory = btn.dataset.category;
                renderSnippets();
            };
        });

        $('snippetSearch').oninput = renderSnippets;

        $('addBtn').onclick = () => {
            editingSnippetId = null;
            $('snippetModalTitle').textContent = 'æ·»åŠ ç‰‡æ®µ';
            $('snippetTitleInput').value = '';
            $('snippetContentInput').value = '';
            $('snippetCategorySelect').value = 'other';
            $('snippetTagsInput').value = '';
            $('snippetModal').classList.add('active');
        };

        $('closeSnippetModal').onclick = () => $('snippetModal').classList.remove('active');

        $('saveSnippetBtn').onclick = () => {
            const title = $('snippetTitleInput').value.trim();
            const content = $('snippetContentInput').value.trim();
            if (!title || !content) {
                showToast('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            const category = $('snippetCategorySelect').value;
            const tags = $('snippetTagsInput').value.trim().split(/\s+/);
            
            if (editingSnippetId) {
                updateSnippet(editingSnippetId, title, content, category, tags);
                showToast('å·²æ›´æ–° âœ“');
            } else {
                addSnippet(title, content, category, tags);
                showToast('å·²ä¿å­˜ âœ“');
            }
            
            $('snippetModal').classList.remove('active');
        };

        // ==================== Export/Import ====================
        $('exportBtn').onclick = () => {
            const data = { tasks, snippets, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `é”µé”µé”µé”µçš„å°ä¸–ç•Œå¤‡ä»½_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('å¯¼å‡ºæˆåŠŸ âœ“');
        };

        $('importBtn').onclick = () => $('importFile').click();

        $('importFile').onchange = e => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.tasks) { tasks = data.tasks; saveTasks(); }
                    if (data.snippets) { snippets = data.snippets; saveSnippets(); }
                    renderTasks();
                    renderSnippets();
                    showToast('å¯¼å…¥æˆåŠŸ âœ“');
                } catch (err) {
                    showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        // ==================== Utils ====================
        function showToast(msg) {
            $('toast').textContent = msg;
            $('toast').classList.add('active');
            setTimeout(() => $('toast').classList.remove('active'), 2000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.onclick = e => {
                if (e.target === overlay) overlay.classList.remove('active');
            };
        });

        // ==================== Init ====================
        renderTasks();
        renderSnippets();

        // Check if should show progress dialog
        setTimeout(() => {
            if (shouldShowReminder() && getTopTask()) {
                showProgressDialog();
            }
        }, 1000);

        // Update state
        appState.lastVisit = new Date().toISOString();
        saveState();
    </script>
</body>
</html>
